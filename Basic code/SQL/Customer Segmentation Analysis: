-- Step 1: Select relevant customer data from the database
SELECT 
    customer_id,
    SUM(total_purchase_amount) AS total_spent,
    COUNT(DISTINCT order_id) AS num_orders,
    MAX(order_date) AS latest_purchase_date
FROM 
    orders
GROUP BY 
    customer_id;

-- Step 2: Calculate RFM metrics (Recency, Frequency, Monetary)
WITH customer_rfm AS (
    SELECT 
        customer_id,
        DATEDIFF(NOW(), MAX(order_date)) AS recency,
        COUNT(DISTINCT order_id) AS frequency,
        SUM(total_purchase_amount) AS monetary
    FROM 
        orders
    GROUP BY 
        customer_id
)

-- Step 3: Perform customer segmentation using RFM scores
SELECT 
    customer_id,
    CASE 
        WHEN recency < 30 AND frequency > 5 AND monetary > 1000 THEN 'High Value'
        WHEN recency < 60 AND frequency > 3 AND monetary > 500 THEN 'Mid Value'
        ELSE 'Low Value'
    END AS customer_segment
FROM 
    customer_rfm;
